package main

import little.json.Implicits.{*, given}
import little.json.Json
import Config.OBJECTIVE
import requests.Response
import upickle.default.{ReadWriter, macroRW, read, transform, write}

import scala.collection.mutable
import scala.collection.mutable.ArrayDeque
import scala.io.AnsiColor.*

object Config {
  //#Set API Keys
  val OPENAI_API_KEY = ""
  val PINECONE_API_KEY = ""
  val PINECONE_ENVIRONMENT = "asia-southeast1-gcp-free"

  //#Set Variables
  val YOUR_TABLE_NAME = "test-table"
  val OBJECTIVE = "Solve world hunger."
  val YOUR_FIRST_TASK = "Develop a task list."
  val PINECONE_DIMENSION = 1536
}


@main
def main(): Unit = {
  val pinecone = PineCone(Config.PINECONE_API_KEY, Config.PINECONE_ENVIRONMENT, Config.YOUR_TABLE_NAME, Config.PINECONE_DIMENSION)
  val openAI = OpenAI(Config.OPENAI_API_KEY)
  val first = Task(1, Config.YOUR_FIRST_TASK)
  TaskService.run(first, pinecone, openAI, Config.OBJECTIVE)
}


case class Task(taskId: Int, taskName: String) {
  def print(): Unit = {
    println(s"Task $taskId: $taskName")
  }

  def withTaskId(taskId: Int): Task = {
    Task(taskId, taskName)
  }
}

object TaskService {

  def run(task: Task, pineCone: PineCone, openAI: OpenAI, objective: String): Unit = {
    var taskIdCounter = 1
    val taskList = mutable.Queue[Task]()

    val agent = Agent(pineCone, openAI, objective)
    taskList.enqueue(task)
    while (taskList.nonEmpty) {
      println(s"$MAGENTA$BOLD\n*****TASK LIST*****\n$RESET")
      for (elem <- taskList) {
        elem.print()
      }

      //      # Step 1: Pull the first task
      val task = taskList.dequeue()
      println(s"$GREEN$BOLD\n*****NEXT TASK*****\n$RESET")

      val result = agent.executionAgent(task.taskName)
      println(s"$YELLOW$BOLD\n*****TASK RESULT*****\n$RESET")
      println(result)

      val newTasks = agent.taskCreationAgent(objective, Map.empty /*result*/ , task.taskName, taskList.toList)

      newTasks.foreach(newTask => {
        taskIdCounter += 1
        taskList.enqueue(newTask.withTaskId(taskIdCounter))
      })

      val taskNames = taskList.map(task => task.taskName)
      val prioritized = prioritization(task.taskId + 1, openAI, taskNames, objective)
      taskList.clear()
      taskList.enqueueAll(prioritized)
      println(s"Running task ${task.taskId}")
      task.print()
    }
  }

  //  prioritization_agent
  def prioritization(nextTaskId: Int, openAI: OpenAI, taskNames: mutable.Queue[String], objective: String) = {
    val prompt =
      s"""You are an task prioritization AI tasked with cleaning the formatting of and reprioritizing the following tasks: $taskNames. Consider the ultimate objective of your team:$objective. Do not remove any tasks. Return the result as a numbered list, like:
    #. First task
    #. Second task
    Start the task list with number $nextTaskId."""
    val response = openAI.completionCreate(prompt)
    val newTasks: List[String] = ??? // response.choices[0].text.strip().split('\n') // todo: fix this
    //    val newTasks = response.choices[0].text.strip().split('\n') // todo: fix this
    val newTaskList = mutable.Queue[Task]()
    for (taskString <- newTasks) {
      val taskParts = taskString.strip().split(".", 1)
      if (taskParts.length == 2) {
        val taskId = taskParts(0).strip()
        val taskName = taskParts(1).strip()
        newTaskList.enqueue(Task(taskId.toInt, taskName))
      }
    }
    newTaskList
  }
}

class OpenAI(val apiKey: String) {
  def getAdaEmbedding(text: String): List[Double] = {
    //    return openai.Embedding.create(input = [text], model = "text-embedding-ada-002")["data"][0]["embedding"]
    val text2 = text.replaceAll("\n", " ")
    val response = requests.post("https://something.com", data = Map("data" -> text2))
    List(0.015074335969984531, -0.022246267646551132, 0.0028704325668513775, 0.011734075844287872, 0.00012544653145596385, -0.013945421203970909, -0.006946147885173559, -0.01654856652021408, -0.01916499249637127, -0.033044006675481796, 0.009369994513690472, 0.00490081962198019, -0.005631293635815382, -0.0034531517885625362, 0.003788506146520376, 0.005146524403244257, 0.03577996790409088, -0.023122835904359818, 0.013839170336723328, 0.002586543560028076, -0.0164821594953537, 0.001342246774584055, 0.030839303508400917, -0.007284822408109903, -0.014755583368241787, -0.0017365369712933898, 0.016787631437182426, -0.01327471248805523, 0.03200806304812431, -0.0034863553009927273, 0.015871217474341393, -0.021967358887195587, -0.014304017648100853, 0.00657094968482852, -0.012809865176677704, 0.01067820843309164, -0.00016684700676705688, -0.001638586982153356, 0.015074335969984531, -0.012039546854794025, 0.02550019882619381, 0.005627973470836878, 0.012550879269838333, 0.010339533910155296, -0.04029562696814537, 0.012577441520988941, -0.02135641686618328, -0.007862561382353306, -0.01670794188976288, -0.002467011334374547, 0.016415752470493317, -0.006285400595515966, -0.030281485989689827, -0.001083260402083397, -0.01580481044948101, 0.014197766780853271, -0.03705497458577156, -0.00536898709833622, 0.019589995965361595, -0.03418620303273201, 0.01332783792167902, -0.0025583207607269287, -0.02210017293691635, -0.00810826662927866, -0.00658091064542532, -0.013693075627088547, -0.017066538333892822, 0.008041859604418278, 0.010990319773554802, 0.0056346142664551735, 0.002163200406357646, 0.0063318852335214615, 0.0015738403890281916, -0.007696544285863638, 0.017079820856451988, -0.005916842725127935, -0.0004876746970694512, 0.017650919035077095, 0.009203977882862091, 0.0018212056020274758, 0.031742434948682785, 0.0016726204194128513, -0.011986421421170235, 0.00889186654239893, 0.0048476941883563995, 0.0015198849141597748, 0.006637356244027615, 0.032672129571437836, 0.0024354681372642517, -0.009794997982680798, -0.003675614483654499, -0.000775714055635035, -0.002719357144087553, 0.00933679100126028, -0.022312674671411514, 0.022020483389496803, 0.0009280345984734595, 0.02028062753379345, 0.0012384862639009953, -0.04669724032282829, -0.016986850649118423, 0.007251618895679712, -0.013839170336723328, -0.011328994296491146, -0.007284822408109903, -0.008121547289192677, -0.018142329528927803, 0.0036855756770819426, 0.02826271951198578, -0.0015497679123654962, -0.024889256805181503, 0.015605590306222439, 0.0017398572526872158, -0.03575340285897255, 0.021382978186011314, -0.026044733822345734, 0.008486784994602203, -0.018620457500219345, -0.0036158484872430563, 0.0003071312967222184, 0.028156468644738197, 0.020931413397192955, 0.023760341107845306, -0.00776295131072402, -0.012677052058279514, 0.00329045532271266, -0.03631122037768364, -0.02628379873931408, -0.017172789201140404, -0.030547112226486206, 0.014941522851586342, 0.028315845876932144, 0.0034332298673689365, -0.002196403918787837, -0.026363486424088478, 0.025818951427936554, -0.01900561712682247, -0.0028870340902358294, -0.011661028489470482, -0.00999421812593937, 0.007464120630174875, 0.030520550906658173, -0.003297095885500312, -0.002158219926059246, -0.03315025940537453, 0.002500214846804738, -0.00822115782648325, 0.016389189288020134, -0.015379806980490685, -0.00250187492929399, 0.01409151591360569, 0.005149844568222761, 0.016163406893610954, -0.005853756330907345, 0.029165852814912796, 0.012205563485622406, 0.0016942026559263468, 0.013666512444615364, -0.0033933857921510935, -0.011548136360943317, -0.001857729279436171, -0.033309634774923325, -0.012092672288417816, -0.003977765329182148, 0.0115946214646101, 0.021794700995087624, 0.004784607794135809, 0.006683841347694397, -0.005395549815148115, -0.001387071330100298, -0.0014750603586435318, 0.04924725741147995, -0.012763381004333496, 0.02221970446407795, -0.005395549815148115, 0.016455596312880516, 0.0163626279681921, 0.03259244188666344, -5.011635585105978e-05, 0.006149266846477985, -0.034133076667785645, 0.021688450127840042, -0.015034492127597332, 0.0502566397190094, -0.025779107585549355, -0.004323080647736788, 0.015446214005351067, -0.0062754396349191666, 0.018593894317746162, -0.008672723546624184, 0.028687722980976105, 0.005591449793428183, 0.002730978187173605, -0.0001576123177073896, -0.6659801602363586, 0.002425507176667452, 0.0002693624410312623, -0.022565020248293877, -0.009775076061487198, 0.0007645079167559743, 0.014569644816219807, 0.0016087039839476347, 0.005398869980126619, 0.010917272418737411, 0.0039943670853972435, 0.0007628477178514004, -0.033787764608860016, -0.04555504396557808, 0.00336848315782845, -0.023149399086833, -0.00820123590528965, -0.03147680684924126, -0.03105180524289608, 0.0076234969310462475, -0.019178275018930435, 0.01252431608736515, -0.005986569914966822, 0.0016103640664368868, 0.013985265046358109, -0.014569644816219807, 0.0010932213626801968, -0.029643980786204338, 0.012577441520988941, -0.006238915957510471, 0.016429034993052483, 0.011641106568276882, -0.01229853369295597, 0.013414166867733002, 0.05323166400194168, -0.0069262259639799595, -0.017212634906172752, -0.009575855918228626, -0.0034697535447776318, 0.0279970932751894, -0.018368111923336983, -0.010478988289833069, 0.007902405224740505, -0.007889123633503914, -0.007085602264851332, 0.012325095944106579, 0.021794700995087624, -0.0029700426384806633, -6.178941839607432e-05, -0.015818091109395027, 0.0021648607216775417, 0.010452425107359886, -0.022272828966379166, 0.006474659778177738, 0.0039611635729670525, 0.012444628402590752, 0.03060023859143257, -0.01409151591360569, 0.011209461838006973, 0.01162782497704029, -0.012955959886312485, 0.008785615675151348, -0.023840028792619705, -0.0060164532624185085, -0.027678340673446655, 0.026084577664732933, -0.0030879147816449404, 0.01923139952123165, 0.010206719860434532, -0.001729896292090416, 0.005843795370310545, 0.007643418852239847, -0.0033402603585273027, 0.007025836035609245, 0.0182618610560894, 0.012119235470890999, 0.005631293635815382, -0.010405940003693104, -0.003330299397930503, 0.00033867452293634415, 0.0003857818082906306, -0.024690035730600357, -0.00147007976192981, 0.0013962022494524717, 0.02937835454940796, -0.0013762802118435502, -0.011315712705254555, -0.019882185384631157, 0.010711411945521832, 0.02366737090051174, 0.015432932414114475, 0.02430487610399723, 0.007835998199880123, -0.0021250166464596987, 0.0029119367245584726, 0.026562707498669624, -0.03381432592868805, -0.0009736891952343285, 0.05748169869184494, -0.013626668602228165, -0.014755583368241787, -0.011348916217684746, 0.011548136360943317, 0.008061781525611877, 0.023441588506102562, 0.010711411945521832, -0.013361041434109211, 0.011036804877221584, 0.03965812176465988, -0.019483745098114014, -0.003798467107117176, -0.01075789611786604, -0.037851858884096146, 0.0041172197088599205, 0.008048499934375286, -0.021130632609128952, 0.02087828703224659, 0.002633028430864215, 0.013201665133237839, -0.0163227841258049, 0.021343134343624115, 0.017664199694991112, 0.03030804917216301, -0.011282510124146938, -0.003911358769983053, 0.021715013310313225, 0.010910632088780403, -0.008812177926301956, -0.034690894186496735, -0.034797146916389465, -0.010253204964101315, 0.0026977749075740576, 0.0008263491909019649, -0.008998117409646511, 0.011196181178092957, 0.00836725253611803, 0.0011878510704264045, -0.01751810498535633, 0.013261431828141212, 0.017876701429486275, -0.005661176983267069, -0.002555000362917781, -0.0091906962916255, -0.015791529789566994, 0.009084445424377918, -0.011162977665662766, -0.002807346172630787, -0.014357143081724644, 0.002379022538661957, -0.026310361921787262, 0.005335783585906029, -0.01069813035428524, -0.030254922807216644, -0.0010732993250712752, 0.012165719643235207, -0.016096999868750572, 0.009814919903874397, -0.024145500734448433, -0.014224329963326454, -0.03787842020392418, 0.02255173772573471, 0.01722591556608677, -0.014596207067370415, -0.0013646590523421764, -0.024211907759308815, -0.01960327848792076, -0.0057242633774876595, 0.014649332500994205, -0.04239407926797867, -0.016375908628106117, 0.009575855918228626, -0.03577996790409088, -0.02828928269445896, 0.029431479051709175, -0.009941092692315578, 0.034983083605766296, -0.03078617714345455, -0.009675465524196625, -0.008546550758183002, 0.005488519091159105, 0.003927960060536861, -0.014848553575575352, -0.02382674813270569, -0.010173516348004341, 0.020440002903342247, -0.005485198926180601, 0.013135258108377457, 0.031370557844638824, 0.008194594644010067, 0.01800951547920704, -0.0030397698283195496, 0.035700276494026184, 0.013533699326217175, 0.010412581264972687, 0.005100039765238762, 0.00911764893680811, -0.0045687854290008545, 0.0010600179666653275, -0.005571527872234583, 0.003941241651773453, 0.009668825194239616, -0.014821990393102169, 0.010943835601210594, -0.008114906959235668, 0.01669466122984886, -0.023800184950232506, -0.0003241480444557965, -0.019178275018930435, 0.014543081633746624, 0.022060327231884003, 0.01330791600048542, -0.01714622788131237, 0.0012492772657424212, -0.010970397852361202, 0.008320768363773823, 0.048822253942489624, 0.010671567171812057, 0.0004017609462607652, -0.02948460541665554, 0.004927382338792086, 0.007045757956802845, -0.009775076061487198, 0.0139985466375947, -0.01685403659939766, 0.006912944372743368, 0.023348620161414146, 0.0025981648359447718, 0.02751896344125271, 0.013208306394517422, -0.036922164261341095, -0.013719637878239155, -0.01086414698511362, -0.02337518148124218, 0.0299361702054739, 0.012132516130805016, -0.01920483633875847, 0.012623926624655724, -0.012325095944106579, 0.009848123416304588, 0.006391651462763548, 0.011169617995619774, -0.007583652622997761, 0.03920655697584152, -0.0006420704303309321, -0.007484042551368475, 0.005518402438610792, 0.028422096744179726, 0.010558675974607468, -0.006853178143501282, 0.05139883607625961, -0.009868045337498188, -0.0012990824179723859, -0.020081406459212303, -0.015751685947179794, -0.01183368545025587, -0.010618441738188267, -0.016004031524062157, -0.0012841408606618643, 0.03041430003941059, 0.032937757670879364, 0.021781420335173607, 0.02445097081363201, -0.016043875366449356, -0.010312970727682114, -0.014011828228831291, 0.0015779908280819654, -0.004170345142483711, -0.019483745098114014, -0.005455316044390202, 0.0037220993544906378, -0.028581472113728523, -0.04170345142483711, 0.015379806980490685, -0.04175657406449318, 0.017279040068387985, 0.005226212553679943, 0.0005586469196714461, 0.004233431536704302, -0.0026595909148454666, 0.012198923155665398, 0.007171930745244026, 0.012763381004333496, 0.015671996399760246, 0.018474362790584564, 0.0032506112474948168, -0.03522215038537979, -0.023282213136553764, 0.032300252467393875, -0.03012210875749588, -0.0066805207170546055, 0.011694232001900673, -0.0007404354400932789, 0.018593894317746162, 0.003884795820340514, -0.011973139829933643, -0.007490683346986771, 0.017279040068387985, 0.0027558808214962482, 0.0002718527102842927, 0.026668958365917206, -0.008055141195654869, 0.010140313766896725, -0.007211775053292513, -0.037187788635492325, 0.027784591540694237, 0.008553192019462585, 0.008453581482172012, -0.015778247267007828, -0.0003581815108191222, -0.023428307846188545, 0.007464120630174875, -0.007537167984992266, 0.006325244437903166, -0.016096999868750572, -0.008885225281119347, 0.006076219025999308, -0.01491495966911316, 0.01819545403122902, 0.021382978186011314, 0.010704770684242249, -0.024318158626556396, -0.02743927575647831, -0.01138876099139452, 0.01492824126034975, 0.09153509140014648, -0.006846537813544273, -0.0051764072850346565, 0.002601485000923276, 0.022897053509950638, 0.017279040068387985, -0.006886381655931473, -0.032858069986104965, -0.003808428067713976, -0.00835397094488144, 0.009144212119281292, 0.00976843573153019, 0.00500374985858798, -0.012291892431676388, 0.013394244946539402, -0.0003845366882160306, -0.0038549129385501146, -0.025022068992257118, -0.011050086468458176, 0.02333533763885498, 0.006703763268887997, 0.014848553575575352, -0.008300845511257648, -0.0013737899716943502, 0.006717044394463301, 0.011143055744469166, 0.01060516107827425, 0.04247376695275307, -0.0018743310356512666, -0.020971257239580154, 0.0022744317539036274, -0.006946147885173559, -0.005525043234229088, 0.0024238470941781998, -0.0015431272331625223, 0.03086586482822895, 0.019696246832609177, 0.014277455396950245, 0.024743162095546722, -0.006683841347694397, 0.003499636659398675, 0.022379079833626747, -0.002244548639282584, -0.01506105437874794, 0.011222743429243565, -0.0006096971337683499, -0.029272103682160378, 0.04552847892045975, -0.01807592250406742, 0.0029119367245584726, 0.024849412962794304, -0.017571231350302696, -0.027226774021983147, -0.01972281001508236, -0.012331736274063587, 0.011348916217684746, -0.012418065220117569, -0.004203548189252615, -0.017650919035077095, -0.028608035296201706, -0.022990023717284203, -0.02407909370958805, 0.02083844318985939, -0.018766552209854126, -0.0017232556128874421, -0.006710403598845005, -0.017584512010216713, -0.031556494534015656, -0.023906435817480087, 0.01666809804737568, 0.012152438051998615, -0.026483017951250076, -0.01071805227547884, 0.004435971844941378, -0.009303588420152664, 0.00743755791336298, 0.004721520934253931, -0.0013223247369751334, 0.008765692822635174, -0.010751255787909031, -0.012577441520988941, -0.023361900821328163, -0.003539480734616518, -0.0115746995434165, 0.004870936274528503, -0.004040851723402739, 0.013825888745486736, -0.026934584602713585, -0.02158219926059246, 0.006262158043682575, -0.0037220993544906378, 0.018381392583251, 0.038303423672914505, -0.02009468711912632, -0.010910632088780403, -0.00016207402222789824, -0.005747505929321051, -0.010359455831348896, 0.0011197840794920921, -0.006129344459623098, -0.004173665307462215, -0.007078961469233036, -0.037745606154203415, -0.009947733953595161, -0.00741763599216938, -0.008114906959235668, -0.00011818329221569002, -0.013062210753560066, 0.0011820404324680567, -0.02102438174188137, 0.03147680684924126, -0.014171204529702663, 0.009682106785476208, 0.0013463972136378288, 0.017212634906172752, 0.027080679312348366, 0.021754857152700424, 0.001902553834952414, 0.01468917727470398, -0.004834412597119808, -0.03540808707475662, -0.01770404353737831, 0.008307486772537231, 0.006786771584302187, -0.007059039548039436, -0.014848553575575352, 0.005143204238265753, -0.028156468644738197, 0.015632152557373047, 0.008752412162721157, -0.03283150494098663, 0.04149094969034195, -0.001332285813987255, -0.01677434891462326, -0.025287697091698647, -0.017836857587099075, -0.013759481720626354, -0.001296592177823186, 0.0026180867571383715, -0.017464980483055115, 0.0029052961617708206, -0.022565020248293877, -0.007616856135427952, -0.010193439200520515, 0.0011911713518202305, -0.03633778169751167, 0.0034697535447776318, 0.005744185298681259, 0.007171930745244026, 0.016575129702687263, -0.013135258108377457, -0.005309220869094133, -0.00048103401786647737, 0.009111008606851101, -0.01552590262144804, -0.0463784858584404, -0.013653231784701347, -0.004688317887485027, 0.02110407128930092, 0.02735958807170391, 0.033787764608860016, 0.008247720077633858, 0.013507136143743992, -0.02419862523674965, 0.005591449793428183, -0.006610793527215719, 0.0008981515420600772, -0.013879014179110527, -0.03261900320649147, 0.029059601947665215, 0.0423409529030323, -0.0055582462809979916, 0.0014011827297508717, -0.02531426027417183, 0.011979781091213226, 0.010412581264972687, -0.013168461620807648, -0.0465378612279892, -0.00494066346436739, -0.040720630437135696, -0.007251618895679712, 0.001216073869727552, -0.018832959234714508, 0.0006723685073666275, -0.0027060757856816053, -0.01788998395204544, 0.024437690153717995, -0.0058471160009503365, 0.010425862856209278, 0.007683263160288334, 0.01572512276470661, -0.025553323328495026, 0.019961874932050705, -0.012949319556355476, -0.03232681378722191, -0.013573543168604374, -0.010233283042907715, -0.003066332545131445, -0.001468419679440558, 0.0006366748712025583, 0.009350072592496872, -0.0008898506639525294, 0.004801209084689617, -0.023202523589134216, -0.012683692388236523, 0.018102483823895454, -0.01085086539387703, 0.006404932588338852, 0.005136563442647457, -0.023866591975092888, -0.007557089906185865, -0.0032987562008202076, -0.025287697091698647, -0.014901679009199142, 0.01714622788131237, -0.010352814570069313, -0.024132220074534416, 0.017544668167829514, -0.004973866976797581, -0.015339963138103485, -0.01782357692718506, -0.020586097612977028, 0.01162782497704029, 0.0007097223424352705, 0.027572089806199074, 0.024663472548127174, -0.0018527487991377711, -0.013088773936033249, 0.03556746616959572, 0.015353244729340076, 0.006477979943156242, 0.016601691022515297, -0.01703997701406479, 0.003712138393893838, -0.039684683084487915, -0.023202523589134216, 0.022950178012251854, -0.017650919035077095, -0.015260275453329086, 0.005989890545606613, 0.004303158726543188, 0.01237822137773037, -0.009277025237679482, -0.009562574326992035, 0.004372885450720787, 0.014025108888745308, -0.019151711836457253, 0.015366526320576668, -0.006806693505495787, -0.024318158626556396, -0.025261133909225464, 0.029218977317214012, -0.00623559532687068, 0.026828333735466003, -0.001603723387233913, -0.010824303142726421, -0.0062422361224889755, -0.006159227807074785, -0.022750958800315857, 0.023175962269306183, 0.001769740367308259, 0.025672856718301773, 0.0014933221973478794, -0.003499636659398675, -0.0012293552281334996, -0.003326979000121355, 0.00820123590528965, -0.0009122629417106509, 0.016787631437182426, 0.020997820422053337, -0.012577441520988941, -0.030812740325927734, -0.003898077178746462, 0.004947304259985685, 0.026908021420240402, -0.001816225121729076, -0.02151579223573208, -0.005495159886777401, -0.005229532718658447, -0.011780560947954655, 0.025898639112710953, -0.020931413397192955, -0.02911272644996643, -0.012457909062504768, -0.013759481720626354, -0.01759779267013073, -0.04778631031513214, -0.0071652899496257305, 0.021409541368484497, -0.0057574668899178505, -0.018168890848755836, -0.004266634583473206, -0.010957116261124611, 0.0016161747043952346, 0.015313400886952877, 0.015552464872598648, -0.00630864268168807, 0.014556363224983215, -0.02762521430850029, 0.007304744329303503, -0.004333041608333588, 0.0279970932751894, -0.008905147202312946, 0.003489675698801875, -0.008360612206161022, -0.003506277222186327, 0.007032476831227541, -0.015977468341588974, -0.007982093840837479, 0.016495440155267715, 0.010817662812769413, 0.0115348557010293, -0.0009529371163807809, -0.0023126157466322184, -0.012271970510482788, 0.02579238824546337, 0.02572598122060299, -0.01741185411810875, 0.008187954314053059, 0.042367517948150635, -0.010631723329424858, -0.002584883477538824, 0.013434088788926601, -0.002593184355646372, 0.003761943429708481, -0.018368111923336983, 0.0073645105585455894, 0.011269228532910347, 0.005903561599552631, -0.005236173514276743, -0.01561887189745903, 0.03463777154684067, -0.004545543342828751, -0.003071313025429845, -0.025739263743162155, -0.001161288353614509, 0.0010301349684596062, -0.0019639800302684307, 0.005468597169965506, -0.010937194339931011, 0.008526628836989403, 0.028422096744179726, 0.008606317453086376, -0.01897905394434929, -0.019842341542243958, -0.01086414698511362, -0.0047381226904690266, -0.007948890328407288, -0.013852451927959919, -0.021754857152700424, -0.0020536293741315603, 0.019563432782888412, -0.004897498991340399, -0.008825459517538548, -0.003635770408436656, 0.015977468341588974, -0.03389401361346245, -0.004771326202899218, -0.009064523503184319, 0.015897780656814575, 0.0030364494305104017, 0.01670794188976288, 0.005455316044390202, 0.04786599799990654, -0.025898639112710953, 0.006401612423360348, -0.0015696899499744177, 0.001602893345989287, -0.016336064785718918, -0.01097703818231821, -0.008978194557130337, -0.00665395800024271, -0.007915686815977097, 0.0003534085117280483, 0.011016882956027985, 0.016123563051223755, 0.0038748348597437143, 0.006179149728268385, 0.016150126233696938, 0.00907780509442091, -0.004734802525490522, -0.0008591375662945211, 0.043005023151636124, -0.002128336811438203, -0.0014045031275600195, -0.018726708367466927, -0.03261900320649147, 0.011076648719608784, -0.007869201712310314, -0.013221587054431438, -0.0298564825206995, -0.0016493781004101038, -0.004744763486087322, -0.0011272549163550138, -0.036815911531448364, -0.01879311539232731, 0.0032887952402234077, -0.02139626070857048, 0.01067820843309164, -0.02236579917371273, 0.00580727169290185, -0.0024902536533772945, 0.019749373197555542, -0.006800053175538778, -0.0002247453958261758, 0.01726575940847397, -0.018275141716003418, 0.004711559973657131, 0.01414464134722948, -0.014211048372089863, 0.0046916380524635315, -0.00266955210827291, 0.0014833611203357577, -0.013480573892593384, 0.02166188694536686, -0.0033236586023122072, -0.014396986924111843, -0.01224540825933218, 0.030626801773905754, 0.0035726840142160654, -0.010399299673736095, -0.00822115782648325, 0.021834544837474823, -0.020161094143986702, 0.015685278922319412, -0.016349345445632935, -0.002379022538661957, -0.001769740367308259, 0.011959859170019627, -0.003974445164203644, 0.0032937757205218077, -0.033495575189590454, -0.006338526029139757, -0.0011123133590444922, -0.003964484203606844, 0.017531385645270348, 0.24161438643932343, -0.007065679877996445, -0.0013629988534376025, 0.03639090806245804, -0.0028239476960152388, 0.02438456565141678, 0.02061266079545021, 0.008639520034193993, -0.0005752486176788807, 0.012172359973192215, -0.012829787097871304, -0.013865732587873936, -0.014795428141951561, 0.0023906435817480087, -0.028475221246480942, -0.006474659778177738, -0.04871600493788719, -0.013719637878239155, -0.024690035730600357, -0.014821990393102169, 0.019244682043790817, 0.009874686598777771, -0.020944694057106972, -0.021449385210871696, 0.03495652228593826, -0.011262587271630764, -0.013586824759840965, -0.004160384181886911, 0.017093101516366005, -0.0030049062334001064, -0.006099461577832699, 0.011979781091213226, 0.012212204746901989, 0.029272103682160378, -0.0019722809083759785, 0.003328639315441251, 0.002550019882619381, -0.01314189936965704, 0.02490253746509552, 0.006076219025999308, 0.007616856135427952, 0.007630137726664543, 0.01500792894512415, 0.017690762877464294, -0.0013588485307991505, 0.016163406893610954, -0.019629839807748795, -0.007543808780610561, 0.00924382172524929, 0.034133076667785645, -0.013566902838647366, -0.01994859240949154, 0.03269869089126587, 0.03601903095841408, -0.0076234969310462475, -0.0031825443729758263, 0.016840755939483643, 0.0012268649879842997, 0.00412718066945672, 0.017093101516366005, 0.0032788340467959642, 0.03195493668317795, 0.009237181395292282, 0.006165868137031794, -0.022498613223433495, 0.019696246832609177, -0.04053469002246857, -0.0037387008778750896, 0.026177547872066498, 0.01669466122984886, 0.00011652312241494656, -0.022047046571969986, -0.0064547378569841385, 0.007464120630174875, -0.03734716400504112, -0.004485777113586664, 0.00776295131072402, 0.0091707743704319, 0.009396557696163654, 0.028581472113728523, -0.011720794253051281, -0.002550019882619381, 0.0056014107540249825, -0.00926374364644289, -0.032937757670879364, -0.022976741194725037, 0.004671716131269932, 0.020705629140138626, -0.01949702762067318, -0.005910202395170927, -0.00026189169147983193, -0.02329549379646778, -0.0031327393371611834, -0.015685278922319412, -0.0013156840577721596, 0.011328994296491146, 0.015486057847738266, 0.02106422744691372, 0.010253204964101315, -0.019802497699856758, -0.0056810989044606686, 0.00997429620474577, -0.030547112226486206, 0.0030115467961877584, -0.006268798839300871, -0.020214220508933067, -0.019151711836457253, -0.008845381438732147, 0.015486057847738266, -0.01889936625957489, -0.008852021768689156, -0.01621653325855732, -0.01496808510273695, -0.008606317453086376, -0.0025433790870010853, 0.02255173772573471, 0.02337518148124218, -0.008446941152215004, 0.007218415383249521, -8.124452870106325e-05, 0.028714286163449287, -0.01804935932159424, 0.008732490241527557, 0.025805668905377388, -0.02333533763885498, -0.010279767215251923, 0.00743755791336298, 0.007304744329303503, 0.0012384862639009953, -0.035354964435100555, -0.0017448378494009376, -0.023773621767759323, -0.018554050475358963, -0.0013040628982707858, -0.0068930224515497684, 0.026483017951250076, -0.001212753588333726, 0.014981366693973541, -0.013460651971399784, -0.008094985038042068, -0.01233837753534317, -0.018925929442048073, -0.01085086539387703, 0.012670410796999931, 0.013666512444615364, -0.026682239025831223, 0.028581472113728523, -0.01964312233030796, 0.0034797145053744316, 0.006341846194118261, -0.012696973979473114, -0.007729747798293829, -0.0013588485307991505, -0.011076648719608784, -0.0017066539730876684, -0.0023557799868285656, -0.05073476955294609, -0.03633778169751167, 0.024769723415374756, 0.015180586837232113, -0.019961874932050705, 0.024278314784169197, 0.0024072453379631042, -0.007191852666437626, -0.004771326202899218, -0.005076797213405371, -0.17074507474899292, 0.02325564995408058, 0.011070008389651775, -0.018620457500219345, 0.01243134681135416, 0.000140076779644005, 0.027598652988672256, -0.0010625083232298493, -0.013480573892593384, 0.009376635774970055, 0.000994441332295537, -0.00493070250377059, -0.038781553506851196, 0.007318025920540094, 0.006952788680791855, -6.319019303191453e-05, -0.0032655526883900166, 0.027186930179595947, -0.005946726072579622, 0.006517824251204729, 0.018102483823895454, -0.0015655395109206438, 0.006846537813544273, -0.0014617790002375841, 0.004718200769275427, -0.004721520934253931, -0.0037320603150874376, 0.021011101081967354, 0.0010060624917969108, -0.004791248124092817, -0.005624653305858374, -0.0063318852335214615, 0.031556494534015656, 0.002418866381049156, -0.016840755939483643, -0.010439143516123295, -0.0034631129819899797, -0.008639520034193993, -0.014171204529702663, 0.008413737639784813, -0.002908616326749325, 0.03057367540895939, 0.01478214655071497, 0.02151579223573208, -0.000777789275161922, -0.0054984805174171925, 0.004279916174709797, -0.017438417300581932, 0.00827428326010704, -0.02546035498380661, 0.02073219232261181, -0.005428753327578306, 0.004552183672785759, 0.02826271951198578, 0.024411126971244812, -0.0007835998549126089, 0.01492824126034975, 0.0212103221565485, -0.007052398752421141, 0.005153165198862553, -0.020825162529945374, -0.009283666498959064, 0.01945718191564083, -0.0012393163051456213, -0.029218977317214012, 0.003026488469913602, -0.013546980917453766, 0.019443901255726814, -0.016761068254709244, 0.003768583992496133, -0.013228228315711021, -0.004396128002554178, 0.00536898709833622, -0.008732490241527557, -0.005710981786251068, 0.038675300776958466, -0.00926374364644289, -0.007231696974486113, -0.017730606719851494, -0.016535285860300064, 0.00017462905088905245, 0.009217259474098682, -0.010239923372864723, 0.016083719208836555, 0.016282938420772552, -0.022976741194725037, 0.015406370162963867, 0.012165719643235207, 0.004273275379091501, -0.03113149292767048, 0.040056560188531876, -0.023322056978940964, -0.011959859170019627, -0.005727583542466164, 0.00613266509026289, 0.008380534127354622, 0.0020154453814029694, 0.014304017648100853, 0.025393947958946228, -0.0012808205792680383, 0.013314557261765003, -0.0022163258399814367, -0.012955959886312485, 0.018620457500219345, 0.027784591540694237, 0.006461378652602434, 0.0007533017778769135, -0.0008454411290585995, 0.009443041868507862, 0.0005549115594476461, -0.0024537299759685993, 0.01569855958223343, -0.004927382338792086, 0.00846022181212902, 0.022976741194725037, 0.024915818125009537, -0.003848272142931819, -0.005920163355767727, 0.02154235541820526, 0.028793973848223686, 0.02620411105453968, 0.009961014613509178, -0.028315845876932144, 0.018700145184993744, -0.007849279791116714, -0.00995437428355217, -0.10263829678297043, -0.0064879413694143295, 0.0009844803716987371, 0.0018461081199347973, 0.0042533534578979015, 0.03546121343970299, 0.006368408910930157, 0.0019374174298718572, -0.02434471994638443, 0.022392362356185913, -0.020360315218567848, -0.033681511878967285, 0.006763529032468796, 0.009203977882862091, 0.026708802208304405, -0.017199352383613586, -0.01576496660709381, -0.005322502460330725, -0.015127461403608322, 0.02065250463783741, 0.01819545403122902, -0.00753052718937397, 0.006431495305150747, 0.001471739960834384, -0.014330579899251461, 0.028979912400245667, -0.018912646919488907, 0.00527601782232523, 0.005671137943863869, -0.007676622364670038, 0.000734209839720279, -0.016535285860300064, 0.02743927575647831, -0.022312674671411514, 0.007085602264851332, -0.005279337987303734, -0.016163406893610954, -0.012497753836214542, 0.013513777405023575, -0.025951765477657318, 0.013367682695388794, 0.00657094968482852, 0.015911061316728592, -0.024185344576835632, 0.005159805994480848, -0.004449253436177969, 0.0033635026775300503, 0.01340088527649641, 0.031636182218790054, -0.0003058861766476184, -0.0365237221121788, -0.009516090154647827, -0.016004031524062157, -0.01243134681135416, 0.004183626268059015, -0.013082132674753666, -0.0003251856251154095, -0.002767502097412944, -0.0026944545097649097, -0.012384861707687378, 0.013839170336723328, 0.012637208215892315, -0.030095547437667847, 0.0299361702054739, 0.0019722809083759785, 0.017345447093248367, -0.021940795704722404, -0.007550449576228857, 0.019404057413339615, -0.017239196226000786, -0.011382119730114937, 0.02050640992820263, -0.00803521927446127, 0.01747826114296913, -0.01998843625187874, -0.014609488658607006, -0.01067820843309164, -0.014649332500994205, 0.01997515559196472, 0.011966499499976635, -0.022047046571969986, -0.02863459847867489, 0.015751685947179794, 0.0017232556128874421, 0.003330299397930503, -0.01588449813425541, -0.005455316044390202, 0.021940795704722404, 0.01844779960811138, -0.019191555678844452, 0.010392659343779087, -0.0017066539730876684, 0.029590856283903122, 0.00025296828243881464, -0.02646973729133606, 0.042447205632925034, -0.004867616109549999, -0.018832959234714508, 0.023627527058124542, -0.0035328399389982224, -0.020147813484072685, 0.006796732544898987, -0.03540808707475662, 0.028714286163449287, 0.008440299890935421, -0.007802795153111219, 0.013892295770347118, -0.020891569554805756, 0.003013207111507654, 0.013188383542001247, 0.0038615535013377666, 0.008785615675151348, -0.0005993210943415761, 0.013879014179110527, 0.0022196462377905846, -0.008094985038042068, -0.023733777925372124, -0.004093977157026529, 0.038861241191625595, 0.017199352383613586, 0.012139157392084599, 0.015273556113243103, 0.002038687700405717, -0.0003006981569342315, 0.0007811096147634089, 0.017504824325442314, 0.007470761425793171, 0.009682106785476208, -0.001083260402083397, 0.019138431176543236, 0.012623926624655724, -0.003328639315441251, 0.007683263160288334, -0.023813467472791672, -0.002432147739455104, 0.01474230270832777, -0.006992632523179054, -0.026722082868218422, -0.014304017648100853, 0.000517557724379003, 0.022843927145004272, 0.037745606154203415, -0.01342080719769001, -0.012856350280344486, -0.008533269166946411, -0.016721224412322044, 0.02075875550508499, 0.007683263160288334, 0.0115547776222229, 0.010525472462177277, 0.00896491389721632, 0.018952490761876106, 0.016163406893610954, 0.033229947090148926, -0.014436830766499043, -0.0028770731296390295, 0.010518832132220268, -0.034717459231615067, 0.007039117161184549, 0.017757169902324677, 0.006819975096732378, -0.027837716042995453, 0.020957976579666138, -0.019895467907190323, 0.0183415487408638, -0.019656402990221977, -0.006023093592375517, 0.0022661308757960796, 0.008818818256258965, -0.009682106785476208, 0.003908038139343262, -0.027465838938951492, -0.0008197085116989911, 0.015632152557373047, 0.00039200743776746094, -0.011050086468458176, 0.024889256805181503, 0.00812818855047226, -0.011793841607868671, 0.013414166867733002, -0.005475237965583801, 0.012205563485622406, -4.6718199882889166e-05, -0.002237908076494932, -0.02564629353582859, 0.02919241413474083, 0.016535285860300064, -0.0013364361366257071, -0.0008433659677393734, 0.01235829945653677, 0.0009180735796689987, -0.012570801191031933, -0.01774388737976551, -0.0021299971267580986, -0.00404417235404253, 0.0076367780566215515, 0.007743028923869133, 0.025075195357203484, -0.007809435948729515, -0.014410268515348434, 0.0280767809599638, 0.003917999099940062, 0.0092106182128191, -0.002725997706875205, -0.02184782549738884, -0.007244978100061417, -0.03902061656117439, 0.0061061023734509945, -0.0014900017995387316, -0.018726708367466927, -0.013507136143743992, 0.004811170510947704, 0.028315845876932144, 0.010352814570069313, 0.02005484327673912, 0.008101625367999077, -0.014157922938466072, 0.02079859934747219, 0.015140742994844913, -0.018434518948197365, -0.0346643328666687, 0.03915343061089516, -0.0006441456498578191, 0.01228525210171938, -0.0069727106019854546, -0.014383705332875252, 0.005830514244735241, -0.004435971844941378, -0.006946147885173559, 0.00010391621617600322, -0.003496316261589527, -0.026111140847206116, -0.03004242107272148, -0.008699286729097366, -0.018354831263422966, -0.016004031524062157, 0.007689903490245342, -0.013487214222550392, 0.013732919469475746, 0.00458538718521595, -0.020811880007386208, 0.060934849083423615, 0.004957265220582485, 0.029033038765192032, 0.0016145145054906607, 0.028687722980976105, 0.012716895900666714, 0.016880599781870842, 0.02229939214885235, -0.00838717445731163, -0.016747787594795227, 0.008659442886710167, 0.009283666498959064, 0.019589995965361595, -0.034053388983011246, -8.518742833985016e-05, 0.014529800973832607, -0.0212103221565485, 0.006159227807074785, -0.028953351080417633, 0.0036623331252485514, 0.016933726146817207, 0.015486057847738266, 0.010073906742036343, 0.005913522560149431, -0.025261133909225464, -0.0054984805174171925, 0.010392659343779087, -0.006912944372743368, 0.0231892429292202, -0.029697107151150703, -0.010631723329424858, 0.01496808510273695, -0.008639520034193993, -0.02325564995408058, 0.02170173078775406, -0.003805107669904828, 0.004057453479617834, 0.024092374369502068, 0.023348620161414146, 0.0004148347652517259, 0.004748083651065826, 0.02304314821958542, -0.0250884760171175, -0.011700872331857681, -0.016004031524062157, 0.015937624499201775, -0.005186368711292744, 0.00545199541375041, -0.009589137509465218)
  }

  def completionCreate(prompt: String, temperature: Double = 0.5, maxToken: Int = 100): Response = {
    val topP = 1
    val frequencyPenalty = 0
    val presencePenalty = 0
    val body = Map(
      "engine" -> "text-davinci-003",
      "prompt" -> prompt,
      "temperature" -> temperature,
      "max_tokens" -> maxToken,
      "top_p" -> topP,
      "frequency_penalty" -> frequencyPenalty,
      "presence_penalty" -> presencePenalty)
    return requests.post("https://openai.Completion.create", data = body.toString()) // TODO: fix this
  }
}

class PineCone(val apiKey: String, val environment: String, val tableName: String, val demension: Int) {
  val headers = Map("Api-Key" -> apiKey, "Accept" -> "text/plain", "Content-Type" -> "application/json")

  def init(): Unit = {
    println(s"$CYAN$BOLD\n*****OBJECTIVE*****\n$RESET")

    // create index if it doesn't exist
    getAllIndexes().contains(tableName) match {
      case false => createIndex()
      case true => println("Index already exists")
    }
  }

  def getAllIndexes(): List[String] = {
    val response = requests.get(s"https://controller.$environment.pinecone.io/databases", headers = headers)
    read[List[String]](response.data.toString)
  }

  def getIndex(): IndexResponse = { // indexName: String == tableName
    val url = s"https://controller.$environment.pinecone.io/databases/$tableName"
    val data = requests.get(url, headers = headers).data.toString
    read[IndexResponse](data)
  }

  def query(index: IndexResponse, queryEmbedding: List[Double], topK: Int, includeMetadata: Boolean): QueryResponse = {
    val query = QueryRequest(queryEmbedding, topK, includeMetadata)

    val data = requests.post(s"https://${index.host}/${index.table}/query", headers = headers, data = write(query)).data.toString
    read[QueryResponse](data)
  }

  def createIndex(): Response = {
    val headers = Map("Api-Key" -> apiKey, "Accept" -> "text/plain", "Content-Type" -> "application/json")
    val body = CreateIndexRequest("cosine", "p1", tableName, demension)
    val url = s"https://controller.$environment.pinecone.io/databases" // val url = s"https://httpbin.org/post"

    try {
      requests.post(url, headers = headers, data = write(body))
    } catch {
      case e: Exception => println(e); throw e
    }
  }
}

class Agent(val pineCone: PineCone, val openAI: OpenAI, val objective: String) {
  def executionAgent(task: String): Response = {
    val context = contextAgent(query = objective, n = 5)

    val response = openAI.completionCreate(s"You are an AI who performs one task based on the following objective: $objective. Your task: $task\nResponse:",
      temperature = 0.7,
      maxToken = 2000)
    return response // response.choices[0].text.strip()
  }

  def contextAgent(query: String, n: Int): List[String] = {
    val queryEmbedding = openAI.getAdaEmbedding(query)
    val indexRsp = pineCone.getIndex()
    val results = pineCone.query(indexRsp, queryEmbedding, topK = n, includeMetadata = true)
    results.matches.sortBy(_.score).reverse.map(_.metadata("task"))
  }

  //  def task_creation_agent(objective: str, result: Dict, task_description: str, task_list: List[str]):
  def taskCreationAgent(objective: String, result: Map[String, Any], taskDescription: String, taskList: List[Task]): List[Task] = {
    val prompt = s"You are an task creation AI that uses the result of an execution agent to create new tasks with the following objective: {objective}, The last completed task has the result: {result}. This result was based on this task description: {task_description}. These are incomplete tasks: {', '.join(task_list)}. Based on the result, create new tasks to be completed by the AI system that do not overlap with incomplete tasks. Return the tasks as an array."
    val response = openAI.completionCreate(prompt = prompt)
    //    new_tasks = response.choices[0].text.strip().split('\n')
    //    return [{"task_name": task_name} for task_name in new_tasks]
    List.empty // TODO: return list of tasks
  }
}